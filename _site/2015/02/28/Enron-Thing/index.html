<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Between People at Enron</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="David Walend's blog about scala, graphs, and coding">
    <link rel="canonical" href="http://dwalend.github.io/blog/2015/02/28/Enron-Thing/">
<!--    <link rel="shortcut icon" href="/blogpublic/favicon.ico"> -->
<!--    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blogpublic/apple-touch-icon-precomposed.png"> -->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/main.css">

</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54450354-1', 'auto');
  ga('send', 'pageview');

</script>
    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/blog/">Intuitive Counter: A Blog about Scala, Graphs, and Coding</a>

      <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          
        
          
        
          <a class="page-link" href="/blog/projects/">Open Source Projects</a>
        
      </div>
    </nav>
  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Between People at Enron</h1>
    <p class="meta">Feb 28, 2015</p>
  </header>

  <article class="post-content">
  <p>The tests in my <a href="https://github.com/dwalend/ScalaGraphMinimizer">graph algorithm library</a> up to now have all used randomly connected graphs -- graphs with some random edges connecting nodes. To test Brandes&#39; betweenness algorithm and (soon) the Louvain method I wanted some graph from nature. The Louvain method would be particularly bad at random graphs.</p>

<p>At ActivateNetworks we did a lot of work with social graphs; I implemented Brandes&#39; algorithm while there. Social graphs are less random because <a href="http://en.wikipedia.org/wiki/Dunbar%27s_number">people form communities of about 150 members, Dunbar&#39;s number</a>, and most people have active relationships with 12 people or less, mostly in that group of 150. I couldn&#39;t share our customers&#39; data, so I pulled in part of the <a href="http://en.wikipedia.org/wiki/Enron_Corpus">Enron email corpus</a> to use for tests, which I turned into a <a href="https://github.com/dwalend/EnronMetaData">still-very-hacky github project</a>.</p>

<p>One thing that always bothered me at ActivateNetworks was our base-level assumption that any email at all meant a relationship might exist. I can swap the FewestNodes semiring in Brandes algorithm for something else, like the MostProbable semiring (with cheezy normalized probability weights from dividing the number of emails between two people by the maximum number in the month). If that&#39;s radically different then I&#39;ve discovered something worth bugging my old comrades about.</p>

<h2>The Enron Email Corpus</h2>

<p>The Justice Department seized Enron&#39;s email logs from the company and went fishing for crooks. The <a href="http://en.wikipedia.org/wiki/Enron_Corpus">Enron email corpus</a> may be the largest clob of email available for research. I&#39;ll let others report <a href="http://en.wikipedia.org/wiki/Enron_scandal">the results</a>; they found what they were looking for. <a href="http://en.wikipedia.org/wiki/Andrew_McCallum">Andrew McCallum</a> purchased a copy of it and made it available to us all. You can download the whole works from a variety of sources, including the full text of the emails. Most of them are remarkably dull, but are great fodder for a talk on (our total lack of) electronic privacy.</p>

<p>I downloaded them from <a href="http://foreverdata.org/1009/">Forever Data</a>. (I could not make up that organization&#39;s name for a sophomore short story class.) I use the email metadata only, which, for each email sent, shows who was emailing who. It&#39;s much smaller, and in an easy-to-parse CSV format. I also only used the data for April 2000 for my tests. I don&#39;t need more, and github gets cranky about <a href="https://help.github.com/articles/what-is-my-disk-quota/">files bigger than 100 MB</a>.</p>

<h2>Experience is What You Get When You Really Wanted Something Else</h2>

<p>I&#39;d thought parsing the CSVs would be a good way to get a little experience with <a href="https://github.com/sirthias/parboiled2">Parboiled</a>. It didn&#39;t go so well. The CSV example didn&#39;t work out of the box, but <a href="https://github.com/sirthias">Mathias</a> fixed it when I asked. He then added it as an official example. I had a companion object for my Transmission class, which <a href="https://github.com/sirthias/parboiled2">caused trouble</a>; &quot;Note that there is one quirk: For some reason this notation stops working if you explicitly define a companion object for your case class. You&#39;ll have to write ~&gt; (Person(_, _)) instead.&quot; Having the companion object extend the right Tuple13 fixed it (and possibly problems with Slick).</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">import implicit.expletives

object Transmission extends ((String,Int,Long,Email,Email,String,Boolean,Boolean,Boolean,String,String,String,String) =&gt; Transmission)
</code></pre></div>
<p>I can&#39;t recommend trying to maintain that extends clause in a project where anyone gets to add or remove columns, but at least the compiler will complain if you break it.</p>

<p>My parser ran out of memory. <a href="https://groups.google.com/forum/#!topic/parboiled-user/b7PH49fiFco">Parboiled2 can&#39;t stream</a>.</p>

<h2>Parsing Email Metadata</h2>

<p>I gave up and wrote my own CSV parser. I was a bit <a href="http://tburette.github.io/blog/2014/05/25/so-you-want-to-write-your-own-CSV-code/">intimidated at first</a>, but Scala kept it down to about <a href="https://github.com/dwalend/EnronMetaData/blob/master/src/main/scala/net/walend/enron/CsvParser.scala">25 lines of uninteresting imperative code</a>.</p>

<p>The more interesting, more idiomatic feature of the code is that parsing any line produces either a record of someone sending an email or a description of what problem the parser encountered -- Either[Problem,Transmission] in Scala. The bulk of the code is lines that dig out problems with the data.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">  def create(fileName:String,lineNumber:Int,lineContents:Seq[String]):Either[Problem,Transmission] = {
    if (lineContents.size != 11) {
      if (lineContents.size &lt; 11) Left(Problem(fileName, lineNumber,Category.tooFewColumns.name, s&quot;(${lineContents.size}) in $lineContents&quot;))
      else Left(Problem(fileName, lineNumber,Category.tooManyColumns.name, s&quot;(${lineContents.size}) in $lineContents&quot;))
    }
    else {
      val sender = Email(lineContents(1))
      val recipient = Email(lineContents(2))
      if(!sender.address.contains(&#39;@&#39;)) Left(Problem(fileName,lineNumber,Category.missingAt.name,s&quot;sender $sender&quot;))
      else if (!recipient.address.contains(&#39;@&#39;)) Left(Problem(fileName,lineNumber,Category.missingAt.name,s&quot;recipient $recipient&quot;))

      //Finally it&#39;s OK to make a Transmission
      else  Right(Transmission(fileName = fileName,
</code></pre></div>
<p>This approach works amazingly well. At the end of one pass it gives me a large sample of clean data plus a list of problems to fix, caveat problems I&#39;ve never thought about that bring down the whole works. (I really need Bill Venners&#39; <a href="https://thenewcircle.com/s/post/1704/comparing_functional_error_handling_in_scalaz_and_scalactic?utm_campaign=twitter_channel&amp;utm_source=twitter&amp;utm_medium=social&amp;utm_content=%22Comparing%20Functional%20Error%20Handling%20in%20Scalaz%20and%20Scalactic%2C%22%20%40bvenners%27s%20talk%20from%20%40nescalas%20is%20now%20live!">Eastwood -- Good, Bad, or Ugly</a> , late in the talk and in an unrecorded session the next day. We couldn&#39;t figure out how to make Eastwood play nice with monadic idioms. However, Either will get us through the night.)</p>

<p>The only really aggravating problem I encountered while reading in the data was &quot;java.nio.charset.MalformedInputException: Input length = 1&quot; , which is pretty unhelpful. Adding the iso-8859-1 encoding parameter to</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Source.fromFile(file,&quot;iso-8859-1&quot;).getLines().toIterable.drop(1)
</code></pre></div>
<p>fixed that. Thank you, Google.</p>

<h2>Slick for Two Tables</h2>

<p>After fiddling around a bit in the REPL I decided that I liked fiddling around with the data. The data was columnar, and not terribly interrelated. What I really wanted was a database.</p>

<p>I hacked in some <a href="http://slick.typesafe.com/">Slick</a> code, which worked exactly as advertised. I&#39;d be highly critical of Slick if it had trouble with a schema of two tables. The remarkable thing about this Slick code is how it worked just like the examples.</p>

<h2>Json, Because I Don&#39;t Want a DB in my Graph Algorithms Test Code</h2>

<p>Github is good at flat files. It&#39;s not that hard to pull a database out of an archive, but I didn&#39;t want to put that flavor of complexity into the graph algorithms project. I am willing to do something uninvasive and standard if it saves some weight of code. <a href="https://github.com/scala/pickling">Scala pickling</a> is the future of Json in Scala (but not quite the present yet -- <a href="https://github.com/spray/spray/issues/1002">no spray.io support</a> for example). It uses macros everywhere, so it is very efficient and doesn&#39;t need help in the parsing. That&#39;s the sort of hammer I want to swing.</p>

<p>I was fiddling around in the REPL anyway, so I made my data file for the graph algorithm tests there.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">import scala.pickling._
import scala.pickling.json._
import net.walend.enron.EnronDatabase
import java.nio.file.{Paths, Files}
import java.nio.charset.StandardCharsets

val edges = EnronDatabase.extractTransmissionCounts
val edgeString:String = pickledEdges.value
JSONPickle(edgeString).unpickle[Seq[(String,String,Int)]]
Files.write(Paths.get(&quot;results/LessEnron2000Apr.txt&quot;), pickledEdges.toString.getBytes(StandardCharsets.UTF_8))
val fileString = scala.io.Source.fromFile(&quot;results/LessEnron2000Apr.txt&quot;).mkString
Files.write(Paths.get(&quot;results/LessEnron2000Apr.txt&quot;), pickledEdges.value.getBytes(StandardCharsets.UTF_8))
</code></pre></div>
<p>The only explicative was figuring out to use pickledEdges.value instead of pickledEdges.toString .</p>

<h2>A Test of Betweenness on the Enron Data</h2>

<p>Pulling the graph back out and running Brandes&#39; betweenness was very tidy:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&quot;Betweenness for Enron data&quot; should &quot;be calculated&quot; in {

  import scala.io.Source
  import scala.pickling._
  import scala.pickling.json._

  val fileContents = Source.fromURL(getClass.getResource(&quot;/Enron2000Apr.json&quot;)).mkString
  val edges = JSONPickle(fileContents).unpickle[Seq[(String,String,Int)]]

  val labelGraphAndBetweenness = Brandes.allLeastPathsAndBetweenness(edges,Seq.empty,FewestNodes,FewestNodes.convertEdgeToLabel)
}
</code></pre></div>
<h2>Results</h2>

<p>In the REPL via sbt test:console, I ran</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">scala&gt; import scala.io.Source
scala&gt; import scala.pickling._
scala&gt; import scala.pickling.json._
scala&gt; import net.walend.graph.SomeGraph._
scala&gt; import net.walend.graph.semiring.Brandes.BrandesSteps
scala&gt; import net.walend.graph.semiring
scala&gt; import net.walend.graph.semiring._
scala&gt; val fileContents = Source.fromURL(getClass.getResource(&quot;/Enron2000Apr.json&quot;)).mkString
scala&gt; val edges = JSONPickle(fileContents).unpickle[Seq[(String,String,Int)]]
scala&gt; val labelGraphAndBetweenness = Brandes.allLeastPathsAndBetweenness(edges,Seq.empty,FewestNodes,FewestNodes.convertEdgeToLabel)
scala&gt; val betweenness = labelGraphAndBetweenness._2
</code></pre></div>
<p>And finally</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">scala&gt; betweenness.to[Seq].sortBy(x =&gt; x._2)
java.lang.AssertionError: assertion failed: List(value _2$mcD$sp, value _2$mcD$sp, value _2$mcD$sp, value _2$mcD$sp, value _2$mcD$sp, value _2$mcD$sp, value _2$mcD$sp, value _2$mcD$sp, value _2$mcD$sp, value _2$mcD$sp)
    at scala.reflect.internal.Symbols$Symbol.suchThat(Symbols.scala:1916)
    at scala.tools.nsc.transform.SpecializeTypes$$anon$2.matchingSymbolInPrefix$1(SpecializeTypes.scala:1460)
    at scala.tools.nsc.transform.SpecializeTypes$$anon$2.transformSelect$1(SpecializeTypes.scala:1483)
 ...
    at sbt.TrapExit$App.run(TrapExit.scala:248)
    at java.lang.Thread.run(Thread.java:745)

 That entry seems to have slain the compiler.  Shall I replay
 your session? I can re-run each line except the last one.
 [y/n]
</code></pre></div>
<p>How civilized, but not quite what I wanted for a finale. It&#39;s only 1700 email addresses, so sortBy should be fine. A quick search lead to <a href="https://issues.scala-lang.org/browse/SI-9099">a bug report vs Scala 2.11.5</a>, already fixed in 2.11.6. Switching to 2.11.4 got through the trouble.</p>

<p>Here&#39;s a list of the addresses with the 10 highest betweenness values in April 2000 at Enron:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(steven.kean@enron.com,53260.58012691413)
(jeff.dasovich@enron.com,59156.98903661527)
(chris.germany@enron.com,61701.19086004503)
(carol.clair@enron.com,67655.27390774187)
(susan.scott@enron.com,76157.68561454736)
(sally.beck@enron.com,82040.94643046238)
(sara.shackleton@enron.com,89571.2341102196)
(vince.kaminski@enron.com,96123.70935699047)
(tana.jones@enron.com,110579.53312945696)
(mark.taylor@enron.com,111545.81230355639)
</code></pre></div>
<p>Switching to the MostProbable semiring was just a matter of mapping the edges to normalized edges and rerunning Brandes&#39;. (The most frequented sender and recipient pair in the sample is vince.kaminski@enron.com writing to vince.kaminski@aol.com 274 times. I&#39;m sure there&#39;s an anecdote behind that.)</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">val weightedEdges = edges.map(x =&gt; (x._1,x._2,x._3.toDouble/274))
val normalizedGraphAndBetweenness = Brandes.allLeastPathsAndBetweenness(edges,Seq.empty,MostProbable,MostProbable.convertEdgeToLabel)
val normalizedBetweenness = normalizedGraphAndBetweenness._2
</code></pre></div>
<p>The nodes with the 10 highest betweennesses using this probability model are not that different; debra.perlingiere@enron.com replaced jeff.dasovich@enron.com, and the other rankings moved around a bit. ActivateNetworks&#39; assumption was fine.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(chris.germany@enron.com,72725.80682360567)
(steven.kean@enron.com,81287.60122108378)
(debra.perlingiere@enron.com,89005.54636283437)
(susan.scott@enron.com,90021.18526949426)
(sally.beck@enron.com,115103.96001437954)
(vince.kaminski@enron.com,119572.49086838862)
(tana.jones@enron.com,159331.96521970455)
(mark.taylor@enron.com,179964.3443774904)
(carol.clair@enron.com,186060.8626406191)
(sara.shackleton@enron.com,206970.0875042239)
</code></pre></div>
<p>Betweenness did not do that good a job finding <a href="http://en.wikipedia.org/wiki/Enron_scandal#Trials">the executives accused in the scandal</a>. Hopefully the Louvain method will do better.</p>

<p>Probably the most interesting of these is Vincent Kaminski, Enron&#39;s managing director for research. <a href="http://www.nytimes.com/2006/01/29/business/businessspecial3/29profiles.html?pagewanted=all">An NY Times article</a> describes him as ethical, professional, and heroic, in contrast to the other power brokers around him. &quot;As Enron was collapsing, Mr. Kaminski helped all 50 of his former research staff members find jobs elsewhere.&quot;</p>

  </article>

</div>

      
<div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'intuitivecounter'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Intuitive Counter: A Blog about Scala, Graphs, and Coding</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Intuitive Counter: A Blog about Scala, Graphs, and Coding</li>
        <li><a href="mailto:david@walend.net">david@walend.net</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/dwalend">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">dwalend</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/dwalend">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">dwalend</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">David Walend's blog about scala, graphs, and coding</p>
    </div>

  </div>

</footer>


    </body>
</html>